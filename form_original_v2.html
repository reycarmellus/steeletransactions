<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Steele Transactions Form</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 24px; }
    form { max-width: 980px; margin: 0 auto; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .full { grid-column: 1 / -1; }
    label { display: block; font-size: 14px; margin-bottom: 6px; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; }
    textarea { min-height: 96px; }
    .group { padding: 16px; border: 1px solid #e5e5e5; border-radius: 12px; margin-bottom: 18px; }
    .btns { display: flex; gap: 12px; margin-top: 12px; }
    button { padding: 10px 14px; border: none; border-radius: 10px; cursor: pointer; }
    .primary { background: #2c6bed; color: #fff; }
    .ghost { background: #f3f4f6; }
    .buyer-entry, .seller-entry { display: grid; grid-template-columns: 2fr 2fr 1fr auto; gap: 8px; align-items: end; margin-bottom: 8px; }
    .small { font-size: 12px; color: #555; }
    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; align-items: center; justify-content: center; }
    .modal { background: #fff; padding: 24px; border-radius: 16px; max-width: 480px; width: 90%; text-align: center; }
  </style>
</head>
<body>
  <form id="surveyForm" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false">
    <input type="text" style="display:none" autocomplete="new-password">
    <div class="group">
      <h3>Requestor</h3>
      <div class="row">
        <div>
          <label for="requestorName">Name</label>
          <input id="requestorName" name="requestorName" required>
        </div>
        <div>
          <label for="requestorEmail">Email</label>
          <input id="requestorEmail" name="requestorEmail" type="email" required>
        </div>
        <div class="full">
          <label for="serviceSelection">Service selection</label>
          <select id="serviceSelection" name="serviceSelection" required>
            <option value="">Select one</option>
            <option>MLS Input Only</option>
            <option>Full TC</option>
            <option>Listing Prep</option>
          </select>
        </div>
      </div>
    </div>

    <div class="group">
      <h3>Property</h3>
      <div class="row">
        <div>
          <label for="streetAddress">Street address</label>
          <input id="streetAddress" name="streetAddress">
        </div>
        <div>
          <label for="city">City</label>
          <input id="city" name="city">
        </div>
        <div>
          <label for="state">State</label>
          <input id="state" name="state">
        </div>
        <div>
          <label for="zipCode">Zip code</label>
          <input id="zipCode" name="zipCode">
        </div>
      </div>
    </div>

    <div class="group" id="buyersGroup">
      <h3>Buyers</h3>
      <div id="buyersInfo"></div>
      <div class="btns">
        <button type="button" class="ghost" id="addBuyerBtn">Add buyer</button>
      </div>
    </div>

    <div class="group" id="sellersGroup">
      <h3>Sellers</h3>
      <div id="sellersInfo"></div>
      <div class="btns">
        <button type="button" class="ghost" id="addSellerBtn">Add seller</button>
      </div>
    </div>

    <div class="group">
      <h3>MLS options</h3>
      <div class="row">
        <label><input type="checkbox" name="mlsOptions" value="ARMLS"> ARMLS</label>
        <label><input type="checkbox" name="mlsOptions" value="CRMLS"> CRMLS</label>
        <label><input type="checkbox" name="mlsOptions" value="MRED"> MRED</label>
        <label><input type="checkbox" name="mlsOptions" value="Other"> Other</label>
      </div>
    </div>

    <div class="group">
      <h3>Attachments</h3>
      <p class="small">PDF and images are fine</p>
      <input type="file" id="associatedDocuments" name="associatedDocuments" multiple>
    </div>

    <div class="btns">
      <button class="primary" type="submit">Submit</button>
      <button class="ghost" type="button" id="resetBtn">Reset</button>
    </div>
  </form>

  <div class="modal-overlay" id="okModal">
    <div class="modal">
      <h3>Request submitted</h3>
      <p>Thank you. We will reach out to you within 48 hours. We appreciate your business.</p>
      <div class="btns" style="justify-content:center">
        <button class="primary" id="okClose">Close</button>
      </div>
    </div>
  </div>

<script>
const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbytZaO0ar50PrqgK8TDY0UVH5nQZrC2VvsLnN7uWRapxMlBpEQNpFwuPRsVgE7fHDbeVw/exec';

// repeaters
function makeBuyerRow(idx) {{
  return `
  <div class="buyer-entry">
    <div>
      <label for="buyerName${{idx}}">Name</label>
      <input id="buyerName${{idx}}" name="buyerName">
    </div>
    <div>
      <label for="buyerEmail${{idx}}">Email</label>
      <input id="buyerEmail${{idx}}" name="buyerEmail" type="email">
    </div>
    <div>
      <label for="buyerPhone${{idx}}">Phone</label>
      <input id="buyerPhone${{idx}}" name="buyerPhone" inputmode="tel">
    </div>
    <div>
      <button type="button" class="ghost" onclick="removeEntry(this, 'buyersInfo', '.buyer-entry')">Remove</button>
    </div>
  </div>`;
}}

function makeSellerRow(idx) {{
  return `
  <div class="seller-entry">
    <div>
      <label for="sellerName${{idx}}">Name</label>
      <input id="sellerName${{idx}}" name="sellerName">
    </div>
    <div>
      <label for="sellerEmail${{idx}}">Email</label>
      <input id="sellerEmail${{idx}}" name="sellerEmail" type="email">
    </div>
    <div>
      <label for="sellerPhone${{idx}}">Phone</label>
      <input id="sellerPhone${{idx}}" name="sellerPhone" inputmode="tel">
    </div>
    <div>
      <button type="button" class="ghost" onclick="removeEntry(this, 'sellersInfo', '.seller-entry')">Remove</button>
    </div>
  </div>`;
}}

function removeEntry(btn, containerId, selector) {{
  const el = btn.closest(selector);
  if (el) el.remove();
}}

function ensureAtLeastOne(containerId, builder) {{
  const c = document.getElementById(containerId);
  if (!c.querySelector('*')) c.insertAdjacentHTML('beforeend', builder(1));
}}

function collectData(form) {{
  const data = {{}}, arrays = {{}};
  const elements = form.querySelectorAll('[name]');
  elements.forEach(el => {{
    if (el.type === 'file') return;
    if ((el.type === 'checkbox' || el.type === 'radio') && !el.checked) return;
    const name = el.name.replace(/\\[\\]$/, '');
    const val = el.value;
    if (!arrays[name]) arrays[name] = [];
    arrays[name].push(val);
  }});
  Object.keys(arrays).forEach(k => {{
    data[k] = arrays[k].length === 1 ? arrays[k][0] : arrays[k];
  }});
  return data;
}}

function readFiles(input) {{
  const files = Array.from(input.files || []);
  return Promise.all(files.map(f => new Promise((resolve, reject) => {{
    const reader = new FileReader();
    reader.onload = () => resolve({{
      inputName: input.name || 'associatedDocuments',
      fileName: f.name,
      mimeType: f.type || 'application/octet-stream',
      fileSize: f.size,
      fileData: String(reader.result).split(',')[1]
    }});
    reader.onerror = reject;
    reader.readAsDataURL(f);
  }})));
}}

function showModal() {{
  document.getElementById('okModal').style.display = 'flex';
}}
function hideModal() {{
  document.getElementById('okModal').style.display = 'none';
  window.scrollTo({{ top: 0, behavior: 'smooth' }});
}}

document.getElementById('okClose').addEventListener('click', hideModal);
document.getElementById('resetBtn').addEventListener('click', () => document.getElementById('surveyForm').reset());

document.getElementById('addBuyerBtn').addEventListener('click', () => {{
  const c = document.getElementById('buyersInfo');
  const idx = c.querySelectorAll('.buyer-entry').length + 1;
  c.insertAdjacentHTML('beforeend', makeBuyerRow(idx));
}});
document.getElementById('addSellerBtn').addEventListener('click', () => {{
  const c = document.getElementById('sellersInfo');
  const idx = c.querySelectorAll('.seller-entry').length + 1;
  c.insertAdjacentHTML('beforeend', makeSellerRow(idx));
}});

// init at least one row for each repeater
ensureAtLeastOne('buyersInfo', makeBuyerRow);
ensureAtLeastOne('sellersInfo', makeSellerRow);

document.getElementById('surveyForm').addEventListener('submit', async (e) => {{
  e.preventDefault();
  const form = e.currentTarget;
  const data = collectData(form);
  const attachInput = document.getElementById('associatedDocuments');
  const attachments = await readFiles(attachInput);

  const payload = {{ data, attachments }};
  const resp = await fetch(GAS_ENDPOINT, {{
    method: 'POST',
    headers: {{ 'Content-Type': 'application/json' }},
    body: JSON.stringify(payload),
    mode: 'cors',
    redirect: 'follow',
    cache: 'no-store',
  }});
  let json;
  try {{ json = await resp.json(); }}
  catch(err) {{ json = {{ ok:false, error: 'Invalid response' }}; }}
  if (json && json.ok) {{
    form.reset();
    showModal();
  }} else {{
    alert('Submit error: ' + (json && json.error ? json.error : 'Unknown error'));
  }}
}});
</script>
</body>
</html>
